name: Create-OpenMapTiles
on:
  workflow_dispatch:
    inputs:
      file_URL:
        description: 'input http://download.openstreetmap.fr/extracts/asia/china/anhui.osm.pbf osm file URL'
        required: true
        default: 'http://download.openstreetmap.fr/extracts/asia/china/anhui.osm.pbf'  
env:
  TZ: Asia/Shanghai

jobs:
  Create-OpenMapTiles:
    runs-on: ubuntu-latest
    # if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - uses: actions/checkout@v2
      - name: Initialization running environment
        run: |
          sudo ln -sf /bin/bash /bin/sh 
          sudo mkdir -p /TilesOut && sudo -E chmod 777 /TilesOut
          sudo mkdir -p /coastline && sudo -E chmod 777 /coastline
          sudo mkdir -p /UpReleaseArtifact && sudo -E chmod 777 /UpReleaseArtifact
          chmod +x /extern-disk-space.sh
          /extern-disk-space.sh
      - name: Download map file 
        run: |
          curl -o custom.osm.pbf '${{ github.event.inputs.file_URL }}'
          curl -o coastline/water-polygons-split-4326.zip  https://osmdata.openstreetmap.de/download/water-polygons-split-4326.zip
          cd /coastline
          unzip water-polygons-split-4326.zip
          rm water-polygons-split-4326.zip
                  
      - uses: systemed/tilemaker@v2.0.0
      - name: Run tilemaker
        with:
          # Required, same to --input
          input: custom.osm.pbf
          # Required, same to --output. Could be a directory or a .mbtiles files
          output: /TilesOut
          # Optional, same to --config
          # If not being set, default to resources/config-openmaptiles.config
          config: config-openmaptiles.json
          # Optional, same to --process
          # If not being set, default to resources/process-openmaptiles.lua
          process: process-openmaptiles.lua  
          # Optional, other arguments
          # If not being set, default to '--verbose'
          # extra: --threads 0 
          
      - name: zip Tiles file   
          tar  cvzf - TilesOut/ | split -b 2040m - tiles-mbtiles.tar.gz.
          mv tiles-mbtiles.tar.gz.* /UpReleaseArtifact
          ls -al /UpReleaseArtifact
      - name: clear src release    #v1.0.0 is src
        uses: dev-drprasad/delete-tag-and-release@v0.2.0
        with:
          delete_release: true
          tag_name: v1.0.0   #v1.0.0 is src
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      - name: release src    #v1.0.0 is src
        uses: ncipollo/release-action@v1
        with:
          artifacts: "/UpReleaseArtifact/*"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag:  "v1.0.0"    #v1.0.0 is src
